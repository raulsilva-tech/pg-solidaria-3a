// Objeto que armazena os templates de conteúdo
const templates = {
    'home': document.getElementById('app').innerHTML, // Conteúdo inicial da index.html
    'projetos': null, // Será carregado via fetch
    'cadastro': null  // Será carregado via fetch
};

const appContainer = document.getElementById('app');

// Função para carregar um template via fetch
async function loadTemplate(templateName) {
    if (templates[templateName]) {
        return templates[templateName];
    }

    try {
        const response = await fetch(`/${templateName}_template.html`);
        if (!response.ok) {
            throw new Error(`Template ${templateName} não encontrado.`);
        }
        const html = await response.text();
        templates[templateName] = html;
        return html;
    } catch (error) {
        console.error('Erro ao carregar template:', error);
        return `<h2>Erro ao carregar a página</h2><p>${error.message}</p>`;
    }
}

// Função principal de roteamento e renderização
async function navigate(path) {
    // Remove a barra inicial e divide o caminho
    const route = path.replace(/^\//, '').split('/')[0] || 'home';
    let templateName = route;

    // Mapeamento de rotas para nomes de templates
    if (templateName === 'index.html' || templateName === '') {
        templateName = 'home';
    } else if (templateName === 'projetos.html') {
        templateName = 'projetos';
    } else if (templateName === 'cadastro.html') {
        templateName = 'cadastro';
    }

    const content = await loadTemplate(templateName);
    appContainer.innerHTML = content;

    // Atualiza a URL sem recarregar a página
    history.pushState({ template: templateName }, '', path);

    // Dispara um evento customizado após a renderização do conteúdo
    const event = new CustomEvent('contentRendered', { detail: { template: templateName } });
    document.dispatchEvent(event);
    }

    // Fecha o menu mobile se estiver aberto
    const menuToggle = document.querySelector('.menu-toggle');
    const mainNav = document.querySelector('.main-nav');
    if (menuToggle && mainNav && menuToggle.getAttribute('aria-expanded') === 'true') {
        menuToggle.click();
    }
}

// Intercepta cliques nos links de navegação
document.addEventListener('click', function(e) {
    const target = e.target.closest('a');
    if (target && target.closest('.main-nav')) {
        const href = target.getAttribute('href');
        
        // Verifica se é um link interno que deve ser tratado pelo SPA
        if (href && !href.startsWith('http') && !href.startsWith('#')) {
            e.preventDefault();
            navigate(href);
        }
    }
});

// Trata a navegação de volta (botão Voltar do navegador)
window.addEventListener('popstate', function(e) {
    navigate(document.location.pathname);
});

// Inicializa o SPA na primeira carga
document.addEventListener('DOMContentLoaded', function() {
    // Salva o conteúdo inicial da index.html como template 'home'
    templates['home'] = appContainer.innerHTML;
    
    // Garante que a navegação inicial seja tratada
    navigate(document.location.pathname);
});

// Garante que as máscaras sejam aplicadas após a renderização do template
document.addEventListener('contentRendered', function() {
    if (typeof applyMasks === 'function') {
        applyMasks();
    }
});
